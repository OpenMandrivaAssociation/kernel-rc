Commit ce71038e673ee8291c64631359e56c48c8616dc7 (HEAD -> perf/urgent)
Author: Song Liu <songliubraving@xxxxxx>
Date:   Fri Dec 3 19:32:34 2021 +0000

    perf bpf: Fix building perf with BUILD_BPF_SKEL=1 by default in more distros

    Arnaldo reported that building all his containers with BUILD_BPF_SKEL=1
    to then make this the default he found problems in some distros where
    the system linux/bpf.h file was being used and lacked this:

       util/bpf_skel/bperf_leader.bpf.c:13:20: error: use of undeclared identifier 'BPF_F_PRESERVE_ELEMS'
               __uint(map_flags, BPF_F_PRESERVE_ELEMS);

    So use instead the vmlinux.h file generated by bpftool from BTF info.

    This fixed these as well, getting the build back working on debian:11,
    debian:experimental and ubuntu:21.10:

      In file included from In file included from util/bpf_skel/bperf_leader.bpf.cutil/bpf_skel/bpf_prog_profiler.bpf.c::33:
      :
      In file included from In file included from /usr/include/linux/bpf.h/usr/include/linux/bpf.h::1111:
      :
      /usr/include/linux/types.h/usr/include/linux/types.h::55::1010:: In file included from  util/bpf_skel/bperf_follower.bpf.c:3fatal errorfatal error:
      : : In file included from /usr/include/linux/bpf.h:'asm/types.h' file not found11'asm/types.h' file not found:

      /usr/include/linux/types.h:5:10: fatal error: 'asm/types.h' file not found
      #include <asm/types.h>#include <asm/types.h>

               ^~~~~~~~~~~~~         ^~~~~~~~~~~~~

      #include <asm/types.h>
               ^~~~~~~~~~~~~
      1 error generated.

    Reported-by: Arnaldo Carvalho de Melo <acme@xxxxxxxxxx>
    Signed-off-by: Song Liu <song@xxxxxxxxxx>
    Cc: Jiri Olsa <jolsa@xxxxxxxxxx>
    Cc: Namhyung Kim <namhyung@xxxxxxxxxx>
    Link: http://lore.kernel.org/lkml/CF175681-8101-43D1-ABDB-449E644BE986@xxxxxx
    Signed-off-by: Arnaldo Carvalho de Melo <acme@xxxxxxxxxx>

diff -Naur a/tools/perf/util/bpf_skel/bperf_follower.bpf.c b/tools/perf/util/bpf_skel/bperf_follower.bpf.c
--- a/tools/perf/util/bpf_skel/bperf_follower.bpf.c	2021-12-23 11:53:44.970588590 +0000
+++ b/tools/perf/util/bpf_skel/bperf_follower.bpf.c	2021-12-23 14:26:07.466750581 +0000
@@ -1,7 +1,6 @@
 // SPDX-License-Identifier: (GPL-2.0-only OR BSD-2-Clause)
 // Copyright (c) 2021 Facebook
-#include <linux/bpf.h>
-#include <linux/perf_event.h>
+#include "vmlinux.h"
 #include <bpf/bpf_helpers.h>
 #include <bpf/bpf_tracing.h>
 #include "bperf_u.h"
diff -Naur a/tools/perf/util/bpf_skel/bperf_leader.bpf.c b/tools/perf/util/bpf_skel/bperf_leader.bpf.c
--- a/tools/perf/util/bpf_skel/bperf_leader.bpf.c	2021-12-23 11:53:44.970588590 +0000
+++ b/tools/perf/util/bpf_skel/bperf_leader.bpf.c	2021-12-23 14:26:23.306682040 +0000
@@ -1,7 +1,6 @@
 // SPDX-License-Identifier: (GPL-2.0-only OR BSD-2-Clause)
 // Copyright (c) 2021 Facebook
-#include <linux/bpf.h>
-#include <linux/perf_event.h>
+#include "vmlinux.h"
 #include <bpf/bpf_helpers.h>
 #include <bpf/bpf_tracing.h>
 
diff -Naur a/tools/perf/util/bpf_skel/bpf_prog_profiler.bpf.c b/tools/perf/util/bpf_skel/bpf_prog_profiler.bpf.c
--- a/tools/perf/util/bpf_skel/bpf_prog_profiler.bpf.c	2021-10-31 20:53:10.000000000 +0000
+++ b/tools/perf/util/bpf_skel/bpf_prog_profiler.bpf.c	2021-12-23 14:26:42.276599822 +0000
@@ -1,6 +1,6 @@
 // SPDX-License-Identifier: (GPL-2.0-only OR BSD-2-Clause)
 // Copyright (c) 2020 Facebook
-#include <linux/bpf.h>
+#include "vmlinux.h"
 #include <bpf/bpf_helpers.h>
 #include <bpf/bpf_tracing.h>
 
